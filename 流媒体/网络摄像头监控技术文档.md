# 一、系统架构

## 1.1. 架构图

![](D:\company\drawio\网络摄像机监控系统架构 - 流媒体服务器 - 最终版.png)

## 1.2. 组件说明

IPC：IP Camera（网络摄像机）

IPC Server：网络摄像机管理服务，提供如设备信息注册，控制采流等功能。

IPC Client：拉流客户端服务，主要提供业务鉴权和代理功能。

FFMpeg：音视频处理软件。

Nginx：流媒体服务器。

# 二、软件准备

> 以下安装基于CentOS 7。

## 2.1. Nginx        

### 下载

#### 下载Nginx

nginx下载地址：http://nginx.org/en/download.html

本文档使用的是1.18.0版本（nginx-1.18.0.tar.gz）。

#### 下载nginx-http-flv-module模块

nginx-http-flv-module下载地址：https://github.com/winshining/nginx-http-flv-module/releases

本文档使用的是v1.2.9版本（nginx-http-flv-module-1.2.9.tar.gz）。

### 安装

将上述下载的两个包放置到指定目录，本文放置在/opt目录下。

解压：

~~~shell
[root@localhost opt]# tar -zxvf nginx-1.18.0.tar.gz
[root@localhost opt]# tar -zxvf nginx-http-flv-module-1.2.9.tar.gz
[root@localhost opt]# ls -ll
total 3952
drwxr-xr-x. 8 1001 1001     158 Apr 21  2020 nginx-1.18.0
drwxrwxr-x. 8 root root    4096 Apr 25 10:46 nginx-http-flv-module-1.2.9
~~~

环境准备（安装编译环境和依赖包，已安装请忽略）：

~~~shell
[root@localhost opt]# yum install gcc-c++
[root@localhost opt]# yum install -y pcre pcre-devel
[root@localhost opt]# yum install -y zlib zlib-devel
[root@localhost opt]# yum install -y openssl openssl-devel
~~~

编译安装：

~~~shell
# 进入到nginx-1.18.0目录
[root@localhost opt]# cd nginx-1.18.0
# 开发环境安装时加上--with-debug
[root@localhost nginx-1.18.0]# ./configure --prefix=/usr/local/nginx --add-module=/opt/nginx-http-flv-module-1.2.9 --with-debug
[root@localhost nginx-1.18.0]# make
[root@localhost nginx-1.18.0]# make install
~~~

启动：

~~~shell
[root@localhost /]# cd /usr/local/nginx/sbin
[root@localhost sbin]# ./nginx
[root@localhost sbin]# ps -ef|grep nginx
root      15938      1  0 05:15 ?        00:00:00 nginx: master process ./nginx
nobody    15939  15938  0 05:15 ?        00:00:00 nginx: worker process
root      15942   1725  0 05:15 pts/0    00:00:00 grep --color=auto nginx
[root@localhost sbin]# netstat -tnalp|grep "80"
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      15938/nginx: master
# 测试

[root@localhost sbin]# curl http://localhost
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
[root@localhost sbin]#
~~~

### 配置

打开nginx.conf文件，增加如下配置：

~~~shell
# 文件开头（开发环境这样配置）
error_log logs/error.log debug;

http {
	server {
		
		// 其他配置----
	
        location /live {
            flv_live on;
            chunked_transfer_encoding  on; #open 'Transfer-Encoding: chunked' response
            add_header 'Access-Control-Allow-Credentials' 'true'; #add additional HTTP header
            add_header 'Access-Control-Allow-Origin' '*'; #add additional HTTP header
            add_header Access-Control-Allow-Headers X-Requested-With;
            add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
            add_header 'Cache-Control' 'no-cache';
         }

          # rtmp stat
          location /stat {
              rtmp_stat all;
              rtmp_stat_stylesheet stat.xsl;
          }
          location /stat.xsl {
              # you can move stat.xsl to a different location
              # 可以把nginx-http-flv-module-1.2.9目录下得stat.xsl文件移到其他目录中
              root /opt/nginx-http-flv-module-1.2.9;
          }
:wq
          # rtmp control
          location /control {
             rtmp_control all;
          }
          
          // 其他配置----
    }
}

rtmp {
  server {
    listen 1935;

    application mylive {
      live on;
    }
  }
}
~~~

> 说明：上述为最基本的配置，根据需要自行调整。

重启：

~~~
[root@localhost sbin]# ./nginx -s stop
[root@localhost sbin]# ./nginx
~~~

## 2.2. FFmpeg

### Windows下安装

> 说明：开发阶段ffmpeg安装到开发机上，便于开发和调试。

下载地址：https://ffmpeg.org/download.html#build-windows

根据需要下载软件包，并配置环境变量。

### Linux下安装

#### 安装包安装

##### Centos

Centos核心仓库中无FFmpeg安装包，所以需要使用第三方Yum仓库。若你使用的是其他操作系统，请参考其他资料。

安装步骤如下：

~~~shell
[root@localhost ~]# sudo yum install epel-release
[root@localhost ~]# sudo yum localinstall --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm
[root@localhost ~]# sudo yum install ffmpeg ffmpeg-devel
[root@localhost sbin]# ffmpeg -version
ffmpeg version 3.4.8 Copyright (c) 2000-2020 the FFmpeg developers
built with gcc 4.8.5 (GCC) 20150623 (Red Hat 4.8.5-39)
configuration: --prefix=/usr --bindir=/usr/bin --datadir=/usr/share/ffmpeg --docdir=/usr/share/doc/ffmpeg --incdir=/usr/include/ffmpeg --libdir=/usr/lib64 --mandir=/usr/share/man --arch=x86_64 --optflags='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic' --extra-ldflags='-Wl,-z,relro ' --extra-cflags=' ' --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libvo-amrwbenc --enable-version3 --enable-bzlib --disable-crystalhd --enable-fontconfig --enable-gcrypt --enable-gnutls --enable-ladspa --enable-libass --enable-libbluray --enable-libcdio --enable-libdrm --enable-indev=jack --enable-libfreetype --enable-libfribidi --enable-libgsm --enable-libmp3lame --enable-nvenc --enable-openal --enable-opencl --enable-opengl --enable-libopenjpeg --enable-libopus --disable-encoder=libopus --enable-libpulse --enable-librsvg --enable-libsoxr --enable-libspeex --enable-libtheora --enable-libvorbis --enable-libv4l2 --enable-libvidstab --enable-libvpx --enable-libx264 --enable-libx265 --enable-libxvid --enable-libzvbi --enable-avfilter --enable-avresample --enable-libmodplug --enable-postproc --enable-pthreads --disable-static --enable-shared --enable-gpl --disable-debug --disable-stripping --shlibdir=/usr/lib64 --enable-libmfx --enable-runtime-cpudetect
libavutil      55. 78.100 / 55. 78.100
libavcodec     57.107.100 / 57.107.100
libavformat    57. 83.100 / 57. 83.100
libavdevice    57. 10.100 / 57. 10.100
libavfilter     6.107.100 /  6.107.100
libavresample   3.  7.  0 /  3.  7.  0
libswscale      4.  8.100 /  4.  8.100
libswresample   2.  9.100 /  2.  9.100
libpostproc    54.  7.100 / 54.  7.100
~~~

##### Ubuntu

~~~
sudo apt-get update
sudo apt-get install ffmpeg
~~~

#### 源码安装

使用repository安装包模式，可能软件的版本不够新，需要使用最新的软件版本可以采用源码安装方式，这种方式比上一种方式复杂。

具体的安装步骤参考下面的官方链接：

https://trac.ffmpeg.org/wiki/CompilationGuide

### 测试

#### ffmpeg测试

前提：Nginx已完成安装和配置。

执行下述命令：

~~~shell
ffmpeg -i rtsp://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mov -vcodec libx264 -acodec aac -f flv rtmp://127.0.0.1:1935/mylive/1
~~~

期望结果：控制台持续输出日志。

#### VLC media player安装（非必需）

在开发机上安装该软件。执行上面的ffmpeg的测试命令并且看到控制台持续输出日志后，打开VLC media player，执行：媒体->网络，输入下述链接地址：

~~~
http://nginx所在服务器的ip/live?app=mylive&stream=1
~~~

点击播放。

期望结果：看到视频。

# 三、demo程序

## 3.1. IPC Server

## 3.2. IPC Client

# 四、性能调优

## 4.1. 视频延迟调优

## 4.2. ffmpeg调优

## 4.3. cpu和内存使用率调优

