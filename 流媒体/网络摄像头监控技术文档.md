# 一、系统架构

## 1.1. 架构图

![](D:\company\drawio\网络摄像头监控系统架构 - 流媒体服务器 - 最终版.png)

## 1.2. 组件说明

IPC：IP Camera（网络摄像机）

IPC Server：网络摄像机管理服务，提供如设备信息注册，控制采流等功能。

IPC Client：拉流客户端服务，主要提供业务鉴权和代理功能。

FFMpeg：音视频处理软件。

Nginx：流媒体服务器。

# 二、软件准备

> 以下安装基于CentOS 7。

## 2.1. Nginx        

### 2.1.1. 下载

#### 下载Nginx

nginx下载地址：http://nginx.org/en/download.html

本文档使用的是1.18.0版本（nginx-1.18.0.tar.gz）。

#### 下载nginx-http-flv-module模块

nginx-http-flv-module下载地址：https://github.com/winshining/nginx-http-flv-module/releases

本文档使用的是v1.2.9版本（nginx-http-flv-module-1.2.9.tar.gz）。

### 2.1.2. 安装

将上述下载的两个包放置到指定目录，本文放置在/opt目录下。

解压：

~~~shell
[root@localhost opt]# tar -zxvf nginx-1.18.0.tar.gz
[root@localhost opt]# tar -zxvf nginx-http-flv-module-1.2.9.tar.gz
[root@localhost opt]# ls -ll
total 3952
drwxr-xr-x. 8 1001 1001     158 Apr 21  2020 nginx-1.18.0
drwxrwxr-x. 8 root root    4096 Apr 25 10:46 nginx-http-flv-module-1.2.9
~~~

环境准备（安装编译环境和依赖包，已安装请忽略）：

~~~shell
[root@localhost opt]# yum install gcc-c++
[root@localhost opt]# yum install -y pcre pcre-devel
[root@localhost opt]# yum install -y zlib zlib-devel
[root@localhost opt]# yum install -y openssl openssl-devel
~~~

编译安装：

~~~shell
# 进入到nginx-1.18.0目录
[root@localhost opt]# cd nginx-1.18.0
# 开发环境安装时加上--with-debug
[root@localhost nginx-1.18.0]# ./configure --prefix=/usr/local/nginx --add-module=/opt/nginx-http-flv-module-1.2.9 --with-debug
[root@localhost nginx-1.18.0]# make
[root@localhost nginx-1.18.0]# make install
~~~

启动：

~~~shell
[root@localhost /]# cd /usr/local/nginx/sbin
[root@localhost sbin]# ./nginx
[root@localhost sbin]# ps -ef|grep nginx
root      15938      1  0 05:15 ?        00:00:00 nginx: master process ./nginx
nobody    15939  15938  0 05:15 ?        00:00:00 nginx: worker process
root      15942   1725  0 05:15 pts/0    00:00:00 grep --color=auto nginx
[root@localhost sbin]# netstat -tnalp|grep "80"
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      15938/nginx: master
# 测试

[root@localhost sbin]# curl http://localhost
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>
[root@localhost sbin]#
~~~

### 2.1.3. 配置

打开nginx.conf文件，增加如下配置：

~~~shell
# 文件开头（开发环境这样配置）
error_log logs/error.log debug;

http {
	server {
		
		// 其他配置----
	
        location /live {
            flv_live on;
            chunked_transfer_encoding  on; #open 'Transfer-Encoding: chunked' response
            add_header 'Access-Control-Allow-Credentials' 'true'; #add additional HTTP header
            add_header 'Access-Control-Allow-Origin' '*'; #add additional HTTP header
            add_header Access-Control-Allow-Headers X-Requested-With;
            add_header Access-Control-Allow-Methods GET,POST,OPTIONS;
            add_header 'Cache-Control' 'no-cache';
         }

          # rtmp stat
          location /stat {
              rtmp_stat all;
              rtmp_stat_stylesheet stat.xsl;
          }
          location /stat.xsl {
              # you can move stat.xsl to a different location
              # 可以把nginx-http-flv-module-1.2.9目录下得stat.xsl文件移到其他目录中
              root /opt/nginx-http-flv-module-1.2.9;
          }

          # rtmp control
          location /control {
             rtmp_control all;
          }
          
          // 其他配置----
    }
}

rtmp {
  server {
    listen 1935;

    application mylive {
      live on;
    }
  }
}
~~~

> 说明：上述为最基本的配置，根据需要自行调整。

重启：

~~~
[root@localhost sbin]# ./nginx -s stop
[root@localhost sbin]# ./nginx
~~~

## 2.2. FFmpeg

### 2.2.1. Windows下安装

> 说明：开发阶段ffmpeg安装到开发机上，便于开发和调试。

下载地址：https://ffmpeg.org/download.html#build-windows

根据需要下载软件包，并配置环境变量。

### 2.2.2. Linux下安装

#### 安装包安装

##### Centos

Centos核心仓库中无FFmpeg安装包，所以需要使用第三方Yum仓库。若你使用的是其他操作系统，请参考其他资料。

安装步骤如下：

~~~shell
[root@localhost ~]# sudo yum install epel-release
[root@localhost ~]# sudo yum localinstall --nogpgcheck https://download1.rpmfusion.org/free/el/rpmfusion-free-release-7.noarch.rpm
[root@localhost ~]# sudo yum install ffmpeg ffmpeg-devel
[root@localhost sbin]# ffmpeg -version
ffmpeg version 3.4.8 Copyright (c) 2000-2020 the FFmpeg developers
built with gcc 4.8.5 (GCC) 20150623 (Red Hat 4.8.5-39)
configuration: --prefix=/usr --bindir=/usr/bin --datadir=/usr/share/ffmpeg --docdir=/usr/share/doc/ffmpeg --incdir=/usr/include/ffmpeg --libdir=/usr/lib64 --mandir=/usr/share/man --arch=x86_64 --optflags='-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic' --extra-ldflags='-Wl,-z,relro ' --extra-cflags=' ' --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-libvo-amrwbenc --enable-version3 --enable-bzlib --disable-crystalhd --enable-fontconfig --enable-gcrypt --enable-gnutls --enable-ladspa --enable-libass --enable-libbluray --enable-libcdio --enable-libdrm --enable-indev=jack --enable-libfreetype --enable-libfribidi --enable-libgsm --enable-libmp3lame --enable-nvenc --enable-openal --enable-opencl --enable-opengl --enable-libopenjpeg --enable-libopus --disable-encoder=libopus --enable-libpulse --enable-librsvg --enable-libsoxr --enable-libspeex --enable-libtheora --enable-libvorbis --enable-libv4l2 --enable-libvidstab --enable-libvpx --enable-libx264 --enable-libx265 --enable-libxvid --enable-libzvbi --enable-avfilter --enable-avresample --enable-libmodplug --enable-postproc --enable-pthreads --disable-static --enable-shared --enable-gpl --disable-debug --disable-stripping --shlibdir=/usr/lib64 --enable-libmfx --enable-runtime-cpudetect
libavutil      55. 78.100 / 55. 78.100
libavcodec     57.107.100 / 57.107.100
libavformat    57. 83.100 / 57. 83.100
libavdevice    57. 10.100 / 57. 10.100
libavfilter     6.107.100 /  6.107.100
libavresample   3.  7.  0 /  3.  7.  0
libswscale      4.  8.100 /  4.  8.100
libswresample   2.  9.100 /  2.  9.100
libpostproc    54.  7.100 / 54.  7.100
~~~

##### Ubuntu

~~~
sudo apt-get update
sudo apt-get install ffmpeg
~~~

#### 源码安装

使用repository安装包模式，可能软件的版本不够新，需要使用最新的软件版本可以采用源码安装方式，这种方式比上一种方式复杂。

具体的安装步骤参考下面的官方链接：

https://trac.ffmpeg.org/wiki/CompilationGuide

### 2.2.3. 测试

#### ffmpeg测试

前提：Nginx已完成安装和配置。

执行下述命令：

~~~shell
ffmpeg -i rtsp://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mov -vcodec libx264 -acodec aac -f flv rtmp://127.0.0.1:1935/mylive/1
~~~

期望结果：控制台持续输出日志。

#### VLC media player安装（非必需）

在开发机上安装该软件。执行上面的ffmpeg的测试命令并且看到控制台持续输出日志后，打开VLC media player，执行：媒体->网络，输入下述链接地址：

~~~
http://nginx所在服务器的ip/live?app=mylive&stream=1
~~~

点击播放。

期望结果：看到视频。

# 三、demo程序

## 3.1. IPC Server

### 3.1.1. 结构说明

![](D:\company\document\images\1_包说明.png)

> 说明：导入源码到IDE之后，执行mvn clean

### 3.1.2. 启动说明

说明：确保在开发机上成功安装了FFmpeg软件，并且已搭建好Nginx流媒体服务器。

**第一步**：表创建。

执行data目录下的建表语句，创建相关表。

**第二步**：修改application.yml，需修改的内容如下：

![](D:\company\document\images\2_配置修改.png)

**第三步**：执行IPCServerApplication类启动程序。

### 3.1.3. 使用说明

程序启动之后，浏览器中输入：http://localhost:8081/，出现如下界面：

![](D:\company\document\images\3_主页.png)

访问"设备管理"菜单，添加设备：

![](D:\company\document\images\4_新增设备.png)

设备添加成功后，访问"设备监控"菜单：

![](D:\company\document\images\5_设备监控.png)

点击"预览"按钮，查看摄像头：

![](D:\company\document\images\6_播放展示.png)

## 3.2. IPC Client

待完善。

# 四、Nginx配置

## 4.1. rtmp配置

~~~
rtmp {
	server {
		listen 1935;
		# chunk_size 4000;
		
		drop_idle_publisher 30;
		
		# 客户端连接回调
		on_connect http://127.0.0.1:8081/ipc/notify/;
		
		# IPC应用
		application ipc {
			# enable live streaming
      live on;
      gop_cache on; #open GOP cache for reducing the wating time for the first picture of video
      
      # publish only from localhost
      allow publish 127.0.0.1;
      deny publish all;
      
      # play only from localhost
      allow play 127.0.0.1;
			deny play all; 
			
			# Sets HTTP play callback
			on_play http://127.0.0.1:8081/ipc/notify/;
			# Sets callback on publish command
			on_publish http://127.0.0.1:8081/ipc/notify/;
			# Sets play/publish terminate callback
			on_done http://127.0.0.1:8081/ipc/notify/;
			# Same behavior as on_done but only for play end event.
			on_play_done http://127.0.0.1:8081/ipc/notify/;
			# Same behavior as on_done but only for publish end event.
			on_publish_done http://127.0.0.1:8081/ipc/notify/;
			# Set record_done callback.
			on_record_done http://127.0.0.1:8081/ipc/notify/;
			# Set update callback. 
			on_update http://127.0.0.1:8081/ipc/notify/onUpdate;
		}
	}
}
~~~

## 4.2. http配置

http节点下的配置。

### 统计

~~~
http {
    server {
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
            # rtmp_stat_format json;
        }
        location /stat.xsl {
            root /path/to/stat/xsl/file;
        }
    }
}
~~~

### 控制

~~~
http {
...
    server {
        listen       8080;
        server_name  localhost;
        ....
        location /control {
            rtmp_control all;
        }
     }
}
~~~

# 五、安全

对摄像头加密，可以保证未经授权的人无法篡改摄像头数据，同时也保证摄像头拍摄的内容需要授权才能看。

~~~
@RequestMapping("/check")
@ResponseBody
public String check(HttpServletResponse response, @RequestParam(name = "key") String key) {
   
//验证过程省略
    response.setStatus(200);
    return "{\"code\":\"" + response.getStatus() + "\",\"detail\":\"" + detail + "\"}";
}
~~~

# 五、问题点

## 5.1. 超时问题

###  初次连接rtsp超时问题

~~~
ffmpeg -rtsp_transport tcp -timeout 5000000 -i "rtsp://admin:qwer@1234@192.168.1.108:554/cam/realmonitor?channel=1&subtype=0" -vcodec libx264 -acodec copy -f flv rtmp://192.168.56.104:1935/mylive/1 -loglevel debug
~~~

> 注意版本问题，测试有效的版本是4.x.x

### 摄像头断线后

摄像头断线后的超时问题

# 四、性能调优

从设备数据到采集到前端摄像头视频的播放，链路上涉及到的操作非常之多，任何一个操作的处理都会影响到链路的通畅度。对于性能的优化主要从采流服务器硬件资源的占用优化、视频播放延迟优化等两个方便去考虑。



执行链路：

![](D:\company\drawio\执行链路.png)



以下为根据当前的自测情况进行的调优操作，并不是完善的，需根据具体的情况进行持续调优。

## 4.1. ffmpeg调优

### 分辨率压缩

从大华摄像头获取到的视频分辨率为1920*1080像素，如果当前业务需求不需要在页面中显示此分辨率，可以通过降低视频的分辨率来减少视频的大小，节省带宽。IPC Server示例程序中，将视频进行了缩放处理，相应的ffmpeg命令如下：

~~~
-vf scale=384:216
~~~

### 忽略音频

当前业务需求不需要有音频数据，在流数据处理时可以忽略音频，相应的ffmpeg命令如下：

~~~
-an
~~~

### 使用辅码流

大华摄像头主、辅码流配置信息如下：

![](D:\company\document\images\7_码流.png)

辅码流的分辨率较低，画质较差，对带宽的要求相对于主码流较低。

带宽较低时可以采用辅码流来进行网络传输。

采流接口：

~~~
/ipc/command/gather/start/{deviceId}/{channel}/{streamType}
~~~

提供了码流类型的选择。

## 4.3. flv.js调优

### 4.3.1. 禁用播放器端缓存

测试发现，开启了播放器缓存，延迟非常严重，故需要禁用客户端缓存。禁用参数：

~~~
enableStashBuffer: false // 是否开启播放器端缓存
~~~

详细内容查看device_monitor.html。

### 4.3.2. 做到断线后重连



## 4.4. Nginx调优



# 五、安全

https://blog.csdn.net/string_kai/article/details/101038941

对摄像头加密，可以保证未经授权的人无法篡改摄像头数据，同时也保证摄像头拍摄的内容需要授权才能看。

# 六、服务器配置

# 七、带宽

# 八、线体





# 九、未完成内容

IPC Server程序已完成大部分功能，其中还有一些细节问题需要完善，这里对需要完善的功能做下说明：

1. 新增设备和开启摄像头预览时接入大华SDK进行登录校验（校验摄像头登录用户名、密码等信息）
2. 日志模块
3. 统计模块现是接入Nginx内置的统计页，比较粗糙，争取做一个比较完善的统计监控功能
4. 各种异常处理逻辑完善（摄像头掉线、采流异常等等）
5. 按需监控。提供按需监控功能，即推流的启停由拉流端控制，有拉流需求时才推流。之所以考虑启用此功能，是根据当前的业务需求来定的，拉流端比较少，也不是一直需要查看摄像头视频，按需监控避免了无用的带宽消耗以及服务端资源消耗。按需监控功能涉及到IPC Client和IPC Server端的交互，具体细节待定。

# 十、参考资料

大华SDK下载网址：https://support.dahuatech.com/tools/sdkExploit

# 十一、问题点

## 11.1. FFmpeg问题

### 11.1.1. 情况一：Nginx未启动

~~~
ffmpeg -rtsp_transport tcp -i rtsp://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mov -vcodec libx264 -tune zerolatency -an -vf scale=384:216 -f flv rtmp://192.168.11.129:1935/mylive/1
ffmpeg version 4.4-full_build-www.gyan.dev Copyright (c) 2000-2021 the FFmpeg developers
  built with gcc 10.2.0 (Rev6, Built by MSYS2 project)
  configuration: --enable-gpl --enable-version3 --enable-static --disable-w32threads --disable-autodetect --enable-fontconfig --enable-iconv --enable-gnutls --enable-libxml2 --enable-gmp --enable-lzma --enable-libsnappy --enable-zlib --enable-librist --enable-libsrt --enable-libssh --enable-libzmq --enable-avisynth --enable-libbluray --enable-libcaca --enable-sdl2 --enable-libdav1d --enable-libzvbi --enable-librav1e --enable-libsvtav1 --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxvid --enable-libaom --enable-libopenjpeg --enable-libvpx --enable-libass --enable-frei0r --enable-libfreetype --enable-libfribidi --enable-libvidstab --enable-libvmaf --enable-libzimg --enable-amf --enable-cuda-llvm --enable-cuvid --enable-ffnvcodec --enable-nvdec --enable-nvenc --enable-d3d11va --enable-dxva2 --enable-libmfx --enable-libglslang --enable-vulkan --enable-opencl --enable-libcdio --enable-libgme --enable-libmodplug --enable-libopenmpt --enable-libopencore-amrwb --enable-libmp3lame --enable-libshine --enable-libtheora --enable-libtwolame --enable-libvo-amrwbenc --enable-libilbc --enable-libgsm --enable-libopencore-amrnb --enable-libopus --enable-libspeex --enable-libvorbis --enable-ladspa --enable-libbs2b --enable-libflite --enable-libmysofa --enable-librubberband --enable-libsoxr --enable-chromaprint
  libavutil      56. 70.100 / 56. 70.100
  libavcodec     58.134.100 / 58.134.100
  libavformat    58. 76.100 / 58. 76.100
  libavdevice    58. 13.100 / 58. 13.100
  libavfilter     7.110.100 /  7.110.100
  libswscale      5.  9.100 /  5.  9.100
  libswresample   3.  9.100 /  3.  9.100
  libpostproc    55.  9.100 / 55.  9.100
Input #0, rtsp, from 'rtsp://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mov':
  Metadata:
    title           : BigBuckBunny_115k.mov
  Duration: 00:10:34.63, start: 0.000000, bitrate: N/A
  Stream #0:0: Audio: aac (LC), 12000 Hz, stereo, fltp
  Stream #0:1: Video: h264 (High), yuv420p(progressive), 240x160 [SAR 32:27 DAR 16:9], 24 fps, 24 tbr, 90k tbn, 48 tbc
[tcp @ 0000025794315300] Connection to tcp://192.168.11.129:1935 failed: Error number -138 occurred
[rtmp @ 000002579431c980] Cannot open connection tcp://192.168.11.129:1935
rtmp://192.168.11.129:1935/mylive/1: Unknown error
~~~

### 11.1.2. 读源卡住

测试中发现，读摄像头数据，但是摄像头是未连接的状态，从pump日志可以看到，ffmpeg没有任何的输出流，ffmpeg进程也未结束。

## 11.2. ffmpeg僵尸进程

~~~
 tasklist | findstr "ffmpeg"
 
 ps -ef|grep "ffmpeg"
 
 tasklist | findstr "ffmpeg"
~~~

## 11.3. 断线重连

## 11.4. 启动状态判断不准确

- ffmpeg blocking
- 在启动等待时间过后，ffmpeg启动采流失败

