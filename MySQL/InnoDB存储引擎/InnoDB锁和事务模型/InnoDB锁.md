# 一、InnoDB锁介绍

## 1.1. 共享（Shared）锁和排他（Exclusive）锁

InnoDB实现了标准的行级锁，有两种类型：共享（S）锁和排他（X）锁。

- 共享锁允许持有锁的事务读行。
- 排他锁允许持有锁的事务update或delete行。

事务T1在行r上持有S锁，不同的事务T2请求r上的锁，如下：

- 请求S锁会立即授权。T1和T2在r行上共同持有S锁。
- 请求X锁不会立即授权。

如果T1持有r行的X锁，那么其他事务请求任意的锁都不会立即授权，相反，会等待直到T1释放X锁。

## 1.2. 意向锁（Intention Locks）

InnoDB支持多粒度锁，允许行锁和表锁共存。LOCK TABLES ... WRITE语句使得事务获得指定表的X锁。意向锁是表级锁，它预示事务接下来要请求的行级锁的类型。有两种类型的意向锁：

- 意向共享锁（IS）：意向共享锁（IS）表示事务打算对表中的各个行设置共享锁。
- 意向排他锁（IX）：意向排他锁（IX）表示事务打算对表中的各个行设置排他锁。

例如，SELECT ... LOCK IN SHARE MODE设置IS锁，SELECT ... FOR UPDATE设置IX锁。

意向锁协议如下：

- 在事务可以获取表中某一行的共享锁之前，它必须首先获取表上的IS锁或更强大的锁。
- 在事务可以获得表中一行的排他锁之前，它必须首先获得表上的IX锁。

> 意向共享锁/意向排他锁属于**表锁**，且取得意向共享锁/意向排他锁是取得共享锁/排他锁的**前置条件**。

下表中总结了表级锁类型兼容性。

![](E:\document\images\表级锁兼容矩阵.png)

意向锁除了完整的表请求（比如，LOCK TABLES  ... WRITE）之外不会阻塞其他请求。意向锁的主要目的就是显示有事务正锁定了表的行或者是将要锁定表的行。

## 1.3. 记录锁（Records Locks）

记录锁是索引记录上的锁。

> 单行记录锁。

比如，

~~~sql
SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE
~~~

它会阻止其他事务操作（insert、update或者delete）t.c1值为10的行。

记录锁始终锁定索引记录，即使定义的表没有索引。对于这种情况，InnoDB会创建一个隐藏的聚集索引，并使用该索引进行记录锁定。

## 1.4. 间隙锁（Gap Locks）

间隙锁是：索引记录之间、或索引记录之前、或索引记录之后这些区间的锁。

> 区间锁。区间为开区间，比如(3,5),(-∞, 3),(5,+∞)。

比如,

~~~sql
SELECT c1 FROM t WHERE c1 BETWEEN 10 AND 20 FOR UPDATE;
~~~

它会阻止其他事务往列t.c1中插入15这个值，不论列是否已经存在这样的值，因为10到15这个值范围域都被加锁了。

## 1.5. 临键锁（Next-Key Locks）

Netx-Key Locks = Record Locks + Next-Key Locks，锁定一个范围，并且锁定记录本身。

> 区间为左开右闭区间。

例如，一个索引有10,11,13和20这四个值，那么该索引可能被Next-Key Locking的区间为：

~~~reStructuredText
(-∞, 10]
(10, 11]
(11, 13]
(13, 20]
(20, +∞)
~~~

InnoDB的默认事务隔离级别是RR，在这种级别下，如果你使用select ... in share mode或者select ... for update语句，那么InnoDB会使用临键锁，因而可以防止**幻读**。

> 但即使你的隔离级别是RR，如果你这是使用普通的select语句，那么InnoDB将是快照读，不会使用任何锁，因而还是无法防止**幻读**。

InnoDB存储引擎默认的事务隔离级别是REPEATABLE READ，在该隔离级别下，其采用Next-Key Locking的方式来加锁。而在事务隔离级别READ COMMITTED下，其仅采用Record Lock。

## 1.6. 插入意向锁（Insert Intention Locks）

插入意向锁是插入操作在插入行之前设置的一种间隙锁。此锁表示插入的意图，即插入到同一索引间隙中的多个事务如果不是在间隙内的同一位置插入，则不需要等待彼此。假设有值为4和7的索引记录。尝试分别插入值5和6的独立事务，在获得插入行的排他锁之前，每个事务都使用插入意向锁锁定4和7之间的间隙，但不会阻塞彼此因为行不冲突。

## 1.7. 递增锁（AUTO-INC Locks）

AUTO-INC锁是一种特殊的表级锁。主要用于事务中插入自增字段，也就是我们最常用的自增主键id。