# JDK7及以前

- 通过 -XX:PermSize 来设置永久代初始分配空间。默认值是20.75M。
- 通过 -XX:MaxPermSize 来设定永久代最大可分配空间。32位机器默认是 64M，64位机器模式是 82M。
- 当 JVM 加载的类信息容量超过了这个值，会报异常 OutOfMemoryError:PermGen space。

# JDK8及以后

- 元数据区大小可以使用参数 -XX:MetaspaceSize 和 -XX:MaxMetaspaceSize 来指定。
- 默认值依赖于平台。Windows下：-XX:MetaspaceSize 是 21M，-XX:MaxMetaspaceSize的值是 -1，即没有限制。
- 与永久代不同，如果不指定大小，默认情况下，虚拟机会耗尽所有的可用系统内存。如果元数据区发生溢出，虚拟机一样会抛出异常 OutOfMemoryError:Metaspace。
- -XX:MetaspaceSize：设置初始的元空间大小。对于一个64位的服务器端 JVM 来说，其默认的 -XX:MetaspaceSize值为21MB。这就是初始的高水位线，一旦触及这个水位线，FullGC 将会被触发并卸载没用的类（即这些类对应的类加载器不再存活）然后这个高水位线将会重置。新的高水位线的值取决于 GC 后释放了多少元空间。如果释放的空间不足，那么在不超过 MaxMetaspaceSize 时，适当提高该值。如果释放空间过多，则适当降低该值。
- 如果初始化的高水位线设置过低，上述高水位线调整情况会发生很多次。通过垃圾回收器的日志可以观察到 FullGC 多次调用。为了避免频繁地 GC，建议将 -XX:MetaspaceSize 设置为一个相对较高的值。

~~~
C:\Users\87490\Desktop> jinfo -flag MetaspaceSize 12848
-XX:MetaspaceSize=21807104（20.79688M）
PS C:\Users\87490\Desktop> jinfo -flag MaxMetaspaceSize 12848
-XX:MaxMetaspaceSize=18446744073709486080
~~~

那么`-XX:MetaspaceSize=256m`的含义到底是什么呢？其实，这个JVM参数是指Metaspace扩容时触发FullGC的初始化阈值，也是最小的阈值。这里有几个要点需要明确：

1. 如果没有配置`-XX:MetaspaceSize`，那么触发FGC的阈值是21807104（约20.8m），可以通过jinfo -flag MetaspaceSize pid得到这个值；
2. 如果配置了`-XX:MetaspaceSize`，那么触发FGC的阈值就是配置的值；
3. Metaspace由于使用不断扩容到`-XX:MetaspaceSize`参数指定的量，就会发生FGC；且之后每次Metaspace扩容都可能会发生FGC（至于什么时候会，比较复杂，跟几个参数有关）
4. 如果Old区配置CMS垃圾回收，那么扩容引起的FGC也会使用CMS算法进行回收；
5. 如果MaxMetaspaceSize设置太小，可能会导致频繁FullGC，甚至OOM；

JDK8+移除了Perm，引入了Metapsace，它们两者的区别是什么呢？Metasace上面已经总结了，无论`-XX:MetaspaceSize`和`-XX:MaxMetaspaceSize`两个参数如何设置，随着类加载越来越多不断扩容调整，直到MetaspaceSize(如果没有配置就是默认20.8m)触发FGC，上限是`-XX:MaxMetaspaceSize`，默认是几乎无穷大。而Perm的话，我们通过配置`-XX:PermSize`以及`-XX:MaxPermSize`来控制这块内存的大小，jvm在启动的时候会根据`-XX:PermSize`初始化分配一块连续的内存块，这样的话，如果`-XX:PermSize`设置过大，就是一种**赤果果的浪费**。很明显，Metapsace比Perm好多了^^；

JDK7 Perm 验证如下--设置`-XX:PermSize=64m -XX:MaxPermSize=64m`，那么PC初始化就是64m；如果没设置，默认情况下，`PermSize和MaxPermSize都是256M.`

# 总结

`-XX:MetaspaceSize=100M` Sets the size of the allocated class metadata space that will trigger a garbage collection the first time it is exceeded;

`-XX:InitialBootClassLoaderMetaspaceSize=32M` to increase the boot class loader Metaspace;

`-XX:MinMetaspaceFreeRatio=50` to make Metaspaces grow more agressively;

`-XX:MaxMetaspaceFreeRatio=80` to reduce the chance of Metaspaces shrinking;

`-XX:MinMetaspaceExpansion=4M` the minumum size by which a Metaspace is exanded;

`-XX:MaxMetaspaceExpansion=16M` the maximum size to expand a Metaspace by without Full GC.

