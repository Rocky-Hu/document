https://www.elastic.co/guide/cn/elasticsearch/guide/current/pagination.html

å’Œ SQL ä½¿ç”¨ `LIMIT` å…³é”®å­—è¿”å›å•ä¸ª `page` ç»“æœçš„æ–¹æ³•ç›¸åŒï¼ŒElasticsearch æ¥å— `from` å’Œ `size` å‚æ•°ï¼š

- **`size`**

  æ˜¾ç¤ºåº”è¯¥è¿”å›çš„ç»“æœæ•°é‡ï¼Œé»˜è®¤æ˜¯ `10`

- **`from`**

  æ˜¾ç¤ºåº”è¯¥è·³è¿‡çš„åˆå§‹ç»“æœæ•°é‡ï¼Œé»˜è®¤æ˜¯ `0`

å¦‚æœæ¯é¡µå±•ç¤º 5 æ¡ç»“æœï¼Œå¯ä»¥ç”¨ä¸‹é¢æ–¹å¼è¯·æ±‚å¾—åˆ° 1 åˆ° 3 é¡µçš„ç»“æœï¼š

~~~
curl -X GET "localhost:9200/_search?size=5&pretty"
curl -X GET "localhost:9200/_search?size=5&from=5&pretty"
curl -X GET "localhost:9200/_search?size=5&from=10&pretty"
~~~

è€ƒè™‘åˆ°åˆ†é¡µè¿‡æ·±ä»¥åŠä¸€æ¬¡è¯·æ±‚å¤ªå¤šç»“æœçš„æƒ…å†µï¼Œç»“æœé›†åœ¨è¿”å›ä¹‹å‰å…ˆè¿›è¡Œæ’åºã€‚ ä½†è¯·è®°ä½ä¸€ä¸ªè¯·æ±‚ç»å¸¸è·¨è¶Šå¤šä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½äº§ç”Ÿè‡ªå·±çš„æ’åºç»“æœï¼Œè¿™äº›ç»“æœéœ€è¦è¿›è¡Œé›†ä¸­æ’åºä»¥ä¿è¯æ•´ä½“é¡ºåºæ˜¯æ­£ç¡®çš„ã€‚

> **åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ·±åº¦åˆ†é¡µ**
>
> ç†è§£ä¸ºä»€ä¹ˆæ·±åº¦åˆ†é¡µæ˜¯æœ‰é—®é¢˜çš„ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾åœ¨ä¸€ä¸ªæœ‰5ä¸ªä¸»åˆ†ç‰‡çš„ç´¢å¼•ä¸­æœç´¢ã€‚å½“æˆ‘ä»¬è¯·æ±‚ç»“æœçš„ç¬¬ä¸€é¡µï¼ˆç»“æœä»1åˆ°10ï¼‰ï¼Œæ¯ä¸€ä¸ªåˆ†ç‰‡äº§ç”Ÿå‰10ä¸ªç»“æœï¼Œå¹¶ä¸”è¿”å›ç»™åè°ƒèŠ‚ç‚¹ï¼Œåè°ƒæ¥å£å¯¹50ä¸ªç»“æœæ’åºå¾—åˆ°å…¨éƒ¨ç»“æœçš„å‰10ä¸ªã€‚
>
> ç°åœ¨å‡è®¾æˆ‘ä»¬è¯·æ±‚ç¬¬1000é¡µâ€”â€”ç»“æœä»10001åˆ°10010ã€‚æ‰€æœ‰éƒ½ä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œé™¤äº†æ¯ä¸ªåˆ†ç‰‡ä¸å¾—ä¸äº§ç”Ÿå‰10010ä¸ªç»“æœä»¥ä¸ºã€‚ç„¶ååè°ƒèŠ‚ç‚¹å¯¹å…¨éƒ¨50050ä¸ªç»“æœæ’åºæœ€åä¸¢å¼ƒæ‰è¿™äº›ç»“æœä¸­çš„50040ä¸ªç»“æœã€‚
>
> å¯ä»¥çœ‹åˆ°ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¯¹ç»“æœæ’åºçš„æˆæœ¬éšåˆ†é¡µçš„æ·±åº¦æˆæŒ‡æ•°ä¸Šå‡ã€‚è¿™å°±æ˜¯ web æœç´¢å¼•æ“å¯¹ä»»ä½•æŸ¥è¯¢éƒ½ä¸è¦è¿”å›è¶…è¿‡ 1000 ä¸ªç»“æœçš„åŸå› ã€‚

# ä¸‰ç§åˆ†é¡µæ–¹å¼

![](../images/elasticsearch/elasticsearchä¸‰ç§åˆ†é¡µ.png)

## æµ…åˆ†é¡µ(from + size)

~~~json
curl -H 'Content-type: application/json' -X GET 'http://vpc-fat-133.zmaxis.com:9200/chat_message_v01_bak/_search' -d'
{
  "query": {
    "match_all": {}
  },
  "size": 10,
  "from": 0,
  "sort": [
    {
      "_id": {
        "unmapped_type": "keyword",
        "order": "asc"
      }
    }
  ]
}
'
~~~

elasticsearché»˜è®¤é‡‡ç”¨çš„åˆ†é¡µæ–¹å¼æ˜¯from+sizeçš„å½¢å¼ï¼Œä½†æ˜¯åœ¨æ·±åº¦åˆ†é¡µçš„æƒ…å†µä¸‹ï¼Œè¿™ç§ä½¿ç”¨æ–¹å¼çš„æ•ˆç‡æ˜¯éå¸¸ä½çš„ï¼Œæ¯”å¦‚from=5000,size=10ï¼Œeséœ€è¦åœ¨å„ä¸ªåˆ†ç‰‡ä¸ŠåŒ¹é…æ’åºå¹¶å¾—åˆ°5000*10æ¡æœ‰æ•ˆæ•°æ®ï¼Œç„¶ååœ¨ç»“æœé›†ä¸­å–æœ€å10æ¡æ•°æ®è¿”å›ã€‚é™¤äº†ä¼šé‡åˆ°æ•ˆç‡ä¸Šçš„é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªæ— æ³•è§£å†³çš„é—®é¢˜æ˜¯esç›®å‰æ”¯æŒæœ€å¤§çš„skipå€¼max_result_windowé»˜è®¤ä¸º10000ï¼Œä¹Ÿå°±æ˜¯è¯´å½“from+size > max_result_windowæ—¶ï¼Œeså°†è¿”å›é”™è¯¯ã€‚

https://www.elastic.co/guide/cn/elasticsearch/guide/2.x/_query_phase.html

### åŸç†

æŸ¥è¯¢é˜¶æ®µåŒ…å«ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤:

1. å®¢æˆ·ç«¯å‘é€ä¸€ä¸ª `search` è¯·æ±‚åˆ° `Node 3` ï¼Œ `Node 3` ä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º `from + size` çš„ç©ºä¼˜å…ˆé˜Ÿåˆ—ã€‚
2. `Node 3` å°†æŸ¥è¯¢è¯·æ±‚è½¬å‘åˆ°ç´¢å¼•çš„æ¯ä¸ªä¸»åˆ†ç‰‡æˆ–å‰¯æœ¬åˆ†ç‰‡ä¸­ã€‚æ¯ä¸ªåˆ†ç‰‡åœ¨æœ¬åœ°æ‰§è¡ŒæŸ¥è¯¢å¹¶æ·»åŠ ç»“æœåˆ°å¤§å°ä¸º `from + size` çš„æœ¬åœ°æœ‰åºä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚
3. æ¯ä¸ªåˆ†ç‰‡è¿”å›å„è‡ªä¼˜å…ˆé˜Ÿåˆ—ä¸­æ‰€æœ‰æ–‡æ¡£çš„ ID å’Œæ’åºå€¼ç»™åè°ƒèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ `Node 3` ï¼Œå®ƒåˆå¹¶è¿™äº›å€¼åˆ°è‡ªå·±çš„ä¼˜å…ˆé˜Ÿåˆ—ä¸­æ¥äº§ç”Ÿä¸€ä¸ªå…¨å±€æ’åºåçš„ç»“æœåˆ—è¡¨ã€‚

### max_result_window

åšåˆ†é¡µæŸ¥è¯¢ï¼Œå½“åˆ†é¡µè¾¾åˆ°ä¸€å®šé‡çš„æ—¶å€™ï¼ŒæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š

```
Result window is too large, from + size must be less than or equal to: [10000] but was [78020]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting.
```

eså¯¹from + sizeçš„å¤§å°è¿›è¡Œé™åˆ¶ï¼Œå¿…é¡»å°äºç­‰äº10000ã€‚

 **è§£å†³æ–¹æ¡ˆ**

- åœ¨ä¸šåŠ¡ä¸­é™åˆ¶åˆ†é¡µå¤§å°ï¼Œä½¿`from+size<=10000`;
- åŠ¨æ€æ›´æ”¹ç´¢å¼•è®¾ç½®ï¼Œä¸º`max_result_window`å‚æ•°èµ‹å€¼è¶³å¤Ÿå¤§çš„å€¼ï¼›

```json
PUT index/_settings
{
  "index":{
    "max_result_window":100000000
  }
}
```

æ¨èä½¿ç”¨ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºesçš„ä¼˜åŠ¿åœ¨äºæœç´¢ï¼Œä¸åœ¨äºåˆ†é¡µï¼Œå¯¹æ­¤åšé™åˆ¶å°±æ˜¯ä¸ºä¸å½±å“å…¶æ€§ã€‚å°±esçš„é»˜è®¤é…ç½®ï¼Œå‡è®¾æ¯é¡µ10æ¡è®°å½•ï¼Œä¹Ÿæœ‰1000é¡µï¼Œå¦‚æœä¸šåŠ¡ä¸Šå®åœ¨ä¸å¦¥åï¼Œåˆ™ä½¿ç”¨ç¬¬äºŒç§æ–¹æ¡ˆã€‚

## scrollæ·±åˆ†é¡µ

scroll ç±»ä¼¼äºsqlä¸­çš„cursorï¼Œä½¿ç”¨scrollï¼Œæ¯æ¬¡åªèƒ½è·å–ä¸€é¡µçš„å†…å®¹ï¼Œç„¶åä¼šè¿”å›ä¸€ä¸ªscroll_idã€‚æ ¹æ®è¿”å›çš„è¿™ä¸ªscroll_idå¯ä»¥ä¸æ–­åœ°è·å–ä¸‹ä¸€é¡µçš„å†…å®¹ï¼Œæ‰€ä»¥scrollå¹¶ä¸é€‚ç”¨äºæœ‰è·³é¡µçš„æƒ…æ™¯ã€‚scroll çš„æ–¹å¼ï¼Œå®˜æ–¹çš„å»ºè®®ä¸ç”¨äºå®æ—¶çš„è¯·æ±‚ï¼ˆä¸€èˆ¬ç”¨äºæ•°æ®å¯¼å‡ºï¼‰ï¼Œå› ä¸ºæ¯ä¸€ä¸ªscroll_id ä¸ä»…ä¼šå ç”¨å¤§é‡çš„èµ„æºï¼Œè€Œä¸”ä¼šç”Ÿæˆå†å²å¿«ç…§ï¼Œå¯¹äºæ•°æ®çš„å˜æ›´ä¸ä¼šåæ˜ åˆ°å¿«ç…§ä¸Šã€‚

> æœ‰æ•ˆç”Ÿå­˜æ—¶é—´ï¼š
>
> It must be less than (1d). This limit can be set by changing the [search.max_keep_alive] cluster level setting.]]
>
> To prevent against issues caused by having too many scrolls open, the user is not allowed to open scrolls past a certain limit. By default, the maximum number of open scrolls is 500. This limit can be updated with the `search.max_open_scroll_context` cluster setting.

#### åŸç†

**æµç¨‹ï¼š**ä¸ºäº†æ»¡è¶³æ·±åº¦åˆ†é¡µçš„åœºæ™¯ï¼Œes æä¾›äº† scroll çš„æ–¹å¼è¿›è¡Œåˆ†é¡µè¯»å–ï¼ˆå…ˆä»å„ä¸ªåˆ†ç‰‡æ ¹æ®æœç´¢ç»“æœè·å–æ–‡æ¡£IDæ’åºåè¿”å›åˆ°åè°ƒèŠ‚ç‚¹ï¼Œåè°ƒèŠ‚ç‚¹å†è¿›è¡Œæ’åºï¼Œç¬¬ä¸€æ¬¡å’Œfrom+sizeæµç¨‹ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºé€šè¿‡scrollä¼šæŠŠè¿™æ¬¡æœç´¢çš„æ–‡æ¡£IDéƒ½æ±‡æ€»åˆ°åè°ƒèŠ‚ç‚¹å¹¶ç¼“å­˜èµ·æ¥ï¼Œä¸‹æ¬¡æ ¹æ®åˆ†é¡µè·å–çš„æ—¶å€™ä¸å†é‡æ–°æ„é€ ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜é‡Œè·å–ï¼‰å…·ä½“å°±æ˜¯åŸç†ä¸Šæ˜¯å¯¹æŸæ¬¡æŸ¥è¯¢ç”Ÿæˆä¸€ä¸ªæ¸¸æ ‡ scroll_id ï¼Œ åç»­çš„æŸ¥è¯¢åªéœ€è¦æ ¹æ®è¿™ä¸ªæ¸¸æ ‡å»å–æ•°æ®ï¼Œç›´åˆ°ç»“æœé›†ä¸­è¿”å›çš„ hits å­—æ®µä¸ºç©ºï¼Œå°±è¡¨ç¤ºéå†ç»“æŸã€‚å…·ä½“å‚è€ƒå®˜ç½‘https://www.elastic.co/guide/en/elasticsearch/reference/current/paginate-search-results.html

ESçš„æœç´¢æ˜¯åˆ†2ä¸ªé˜¶æ®µè¿›è¡Œçš„ï¼Œå³Queryé˜¶æ®µå’ŒFetché˜¶æ®µã€‚ Queryé˜¶æ®µæ¯”è¾ƒè½»é‡çº§ï¼Œé€šè¿‡æŸ¥è¯¢å€’æ’ç´¢å¼•ï¼Œè·å–æ»¡è¶³æŸ¥è¯¢ç»“æœçš„æ–‡æ¡£IDåˆ—è¡¨ã€‚ è€ŒFetché˜¶æ®µæ¯”è¾ƒé‡ï¼Œéœ€è¦å°†æ¯ä¸ªshardçš„ç»“æœå–å›ï¼Œåœ¨åè°ƒç»“ç‚¹è¿›è¡Œ**å…¨å±€**æ’åºã€‚ é€šè¿‡From+sizeè¿™ç§æ–¹å¼åˆ†æ‰¹è·å–æ•°æ®çš„æ—¶å€™ï¼Œéšç€fromåŠ å¤§ï¼Œéœ€è¦å…¨å±€æ’åºå¹¶ä¸¢å¼ƒçš„ç»“æœæ•°é‡éšä¹‹ä¸Šå‡ï¼Œæ€§èƒ½è¶Šæ¥è¶Šå·®ã€‚

ScrollæŸ¥è¯¢ï¼Œå…ˆåšè½»é‡çº§çš„Queryé˜¶æ®µä»¥åï¼Œå…å»äº†ç¹é‡çš„å…¨å±€æ’åºè¿‡ç¨‹ã€‚ å®ƒåªæ˜¯å°†æŸ¥è¯¢ç»“æœé›†ï¼Œä¹Ÿå°±æ˜¯doc idåˆ—è¡¨ä¿ç•™åœ¨ä¸€ä¸ªä¸Šä¸‹æ–‡é‡Œï¼Œ ä¹‹åæ¯æ¬¡åˆ†æ‰¹å–å›çš„æ—¶å€™ï¼Œåªéœ€æ ¹æ®è®¾ç½®çš„sizeï¼Œåœ¨æ¯ä¸ªshardå†…éƒ¨æŒ‰ç…§ä¸€å®šé¡ºåºï¼ˆé»˜è®¤doc_idç»­)ï¼Œ å–å›è¿™ä¸ªsizeæ•°é‡çš„æ–‡æ¡£å³å¯ã€‚

Queryé˜¶æ®µå¹¶ä¸éœ€è¦fetchçœŸå®çš„æ•°æ®ï¼Œåªéœ€è¦æ‹¿åˆ°æ»¡è¶³æ¡ä»¶çš„doc idåˆ—è¡¨ã€‚ å³ä½¿æœ‰100ä¸‡ä¸ªdoc idçš„åˆ—è¡¨å­˜æ”¾å¹¶ä¸éœ€è¦è€—è´¹å¤šå°‘å†…å­˜ï¼Œå› ä¸ºESä½¿ç”¨äº†éå¸¸ç´§å‡‘çš„æ•°æ®ç»“æ„å’Œå‹ç¼©ç®—æ³•æ¥å­˜æ”¾è¿™äº›IDã€‚ æ‰€ä»¥Queryé˜¶æ®µæ˜¯è½»é‡çº§çš„ï¼Œ çœŸæ­£è€—è´¹å†…å­˜æ˜¯åœ¨fetché˜¶æ®µçš„å…¨å±€æ’åºã€‚ ä»”ç»†é˜…è¯»ä»¥ä¸Šä¸Šé¢çš„æ–‡æ¡£ï¼Œæœ‰è®²åˆ°å…¨å±€æ’åºçš„åŸç†ä»¥åŠä¸ºä»€ä¹ˆæ·±åº¦åˆ†é¡µæ—¶ï¼Œå¼€é”€è¶Šæ¥è¶Šé«˜ã€‚ 

**ç¼ºç‚¹**ï¼šç”±äºscroll_id ä¸ä»…ä¼šå ç”¨å¤§é‡çš„èµ„æºï¼ˆç‰¹åˆ«æ˜¯æ’åºçš„è¯·æ±‚ï¼‰ï¼Œè€Œä¸”æ˜¯ç”Ÿæˆçš„å†å²å¿«ç…§ï¼Œå¯¹äºæ•°æ®çš„å˜æ›´ä¸ä¼šåæ˜ åˆ°å¿«ç…§ä¸Šã€‚è¿™ç§æ–¹å¼å¾€å¾€ç”¨äºéå®æ—¶å¤„ç†å¤§é‡æ•°æ®çš„æƒ…å†µã€‚

**å…ˆè·å–ç¬¬ä¸€ä¸ªscroll_id**

å…ˆè·å–ç¬¬ä¸€ä¸ªscroll_idï¼Œurlå‚æ•°åŒ…æ‹¬indexå’Œscrollï¼Œscrollå­—æ®µæŒ‡å®šäº†scroll_idçš„æœ‰æ•ˆç”Ÿå­˜æ—¶é—´ï¼Œè¿‡æœŸåä¼šè¢«esè‡ªåŠ¨æ¸…ç†ã€‚

~~~json
curl -H 'Content-type: application/json' -XGET 'http://vpc-fat-133.zmaxis.com:9200/chat_message_v01_bak/_search?pretty&scroll=2m' -d '
{
  "query": {
    "match_all": {}
  },
  "size": 10,
  "from": 0,
  "sort": [
    {
      "_id": {
        "unmapped_type": "keyword",
        "order": "asc"
      }
    }
  ]
}
'
~~~

~~~json
{ 
  "_scroll_id": "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAKzbLcWcVpHUkhwWkZRMDJZalRqZG1mRUFjUQ==",
  ......
}
~~~

**å¸¦scroll idè¯·æ±‚**

åœ¨éå†æ—¶å€™ï¼Œæ‹¿åˆ°ä¸Šä¸€æ¬¡éå†ä¸­çš„_scroll_idï¼Œç„¶åå¸¦scrollå‚æ•°ï¼Œé‡å¤ä¸Šä¸€æ¬¡çš„éå†æ­¥éª¤ï¼Œç›´åˆ°è¿”å›çš„æ•°æ®ä¸ºç©ºï¼Œè¡¨ç¤ºéå†å®Œæˆã€‚æ¯æ¬¡éƒ½è¦ä¼ å‚æ•°scrollï¼Œåˆ·æ–°æœç´¢ç»“æœçš„ç¼“å­˜æ—¶é—´ï¼Œå¦å¤–ä¸éœ€è¦æŒ‡å®šindexï¼ˆä¸è¦æŠŠç¼“å­˜çš„æ—¶æ—¶é—´è®¾ç½®å¤ªé•¿ï¼Œå ç”¨å†…å­˜ï¼‰åç»­æŸ¥è¯¢ï¼š

~~~json
curl -H 'Content-type: application/json' -XGET 'http://vpc-fat-133.zmaxis.com:9200/_search/scroll?pretty' -d '
{
  "scroll_id": "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAKzgtAWcVpHUkhwWkZRMDJZalRqZG1mRUFjUQ==",
  "scroll": "2m"
}
'
~~~

~~~json
{ - 
  "_scroll_id": "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAKzgtAWcVpHUkhwWkZRMDJZalRqZG1mRUFjUQ==",
  ......
}
~~~

> **scroll idåˆ é™¤**
>
> æ ¹æ®å®˜æ–¹æ–‡æ¡£çš„è¯´æ³•ï¼Œscrollçš„æœç´¢ä¸Šä¸‹æ–‡ä¼šåœ¨scrollçš„ä¿ç•™æ—¶é—´æˆªæ­¢åè‡ªåŠ¨æ¸…é™¤ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“scrollæ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ï¼Œæ‰€ä»¥ä¸€ä¸ªå»ºè®®å°±æ˜¯å½“ä¸éœ€è¦äº†scrollæ•°æ®çš„æ—¶å€™ï¼Œå°½å¯èƒ½å¿«çš„æŠŠscroll_idæ˜¾å¼åˆ é™¤æ‰ã€‚
>
> æ¸…é™¤æŒ‡å®šçš„scroll_idï¼š
>
> ~~~json
> DELETE _search/scroll 
> {
>     "scroll_id" : "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAKzh6sWcVpHUkhwWkZRMDJZalRqZG1mRUFjUQ=="
> }
> 
> åˆ é™¤å¤šä¸ªï¼š
> 
> {
>     "scroll_id" : [
>       "DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAD4WYm9laVYtZndUQlNsdDcwakFMNjU1QQ==", "DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAABFmtSWWRRWUJrU2o2ZExpSGJCVmQxYUEAAAAAAAAAAxZrUllkUVlCa1NqNmRMaUhiQlZkMWFBAAAAAAAAAAIWa1JZZFFZQmtTajZkTGlIYkJWZDFhQQAAAAAAAAAFFmtSWWRRWUJrU2o2ZExpSGJCVmQxYUEAAAAAAAAABBZrUllkUVlCa1NqNmRMaUhiQlZkMWFB"
>     ]
> }
> ~~~
>
> æ¸…é™¤æ‰€æœ‰çš„scrollï¼š
>
> ~~~
> DELETE _search/scroll/_all
> ~~~

## search_afteræ·±åˆ†é¡µ

search_afteråˆ†é¡µçš„æ–¹å¼æ˜¯æ ¹æ®ä¸Šä¸€é¡µçš„æœ€åä¸€æ¡æ•°æ®æ¥ç¡®å®šä¸‹ä¸€é¡µçš„ä½ç½®ï¼ŒåŒæ—¶åœ¨åˆ†é¡µè¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰ç´¢å¼•æ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼Œè¿™äº›å˜æ›´ä¹Ÿä¼šå®æ—¶çš„åæ˜ åˆ°æ¸¸æ ‡ä¸Šã€‚ä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œå› ä¸ºæ¯ä¸€é¡µçš„æ•°æ®ä¾èµ–äºä¸Šä¸€é¡µæœ€åä¸€æ¡æ•°æ®ï¼Œæ‰€ä»¥æ— æ³•è·³é¡µè¯·æ±‚ã€‚

> ä½¿ç”¨search_afterå¿…é¡»è¦è®¾ç½®from=0ã€‚
> è¿™é‡Œæˆ‘ä½¿ç”¨_idä½œä¸ºå”¯ä¸€å€¼æ’åºã€‚
> æˆ‘ä»¬åœ¨è¿”å›çš„æœ€åä¸€æ¡æ•°æ®é‡Œæ‹¿åˆ°sortå±æ€§çš„å€¼ä¼ å…¥åˆ°search_afterã€‚

ä¸ºäº†æ‰¾åˆ°æ¯ä¸€é¡µæœ€åä¸€æ¡æ•°æ®ï¼Œæ¯ä¸ªæ–‡æ¡£é‚£ä¸ªå¿…é¡»æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€å€¼ï¼Œå®˜æ–¹æ¨èä½¿ç”¨_uuidä½œä¸ºå…¨å±€å”¯ä¸€å€¼ï¼Œå½“ç„¶åœ¨ä¸šåŠ¡ä¸Šçš„idä¹Ÿå¯ä»¥ã€‚

~~~json
curl -H 'Content-type: application/json' -XGET 'http://vpc-fat-133.zmaxis.com:9200/chat_message_v01_bak/_search?pretty' -d '
{
  "query": {
    "match_all": {}
  },
  "size": 3,
  "from": 0,
  "sort": [
    {
      "_id": {
        "unmapped_type": "keyword",
        "order": "asc"
      }
    }
  ]
}
'
~~~

~~~json
{
	"took": 172,
	"timed_out": false,
	"_shards": {
		"total": 1,
		"successful": 1,
		"skipped": 0,
		"failed": 0
	},
	"hits": {
		"total": {
			"value": 10000,
			"relation": "gte"
		},
		"max_score": null,
		"hits": [
			{
				"_index": "chat_message_v01_bak",
				"_type": "colse",
				"_id": "--0RYXXxRkGEym8",
				"_score": null,
				"_source": {
					"fileName": null,
					"loginId": "1688852022706519",
					"corporationId": 1,
					"serverWeChatId": "tian",
					"isRecvMsg": 0,
					"deviceId": null,
					"serverId": "1273336",
					"content": "6666",
					"senderId": "1688852022706519",
					"contentType": "0x2",
					"chatType": 1,
					"clientId": "--0RYXXxRkGEym8",
					"corpId": "1970325139148973",
					"offset": 30420,
					"conversationId": "R:10696051277016237",
					"url": null,
					"sendTime": 1607453304,
					"sequence": "12521780",
					"@timestamp": "2020-12-11T09:49:08.482308Z",
					"recverId": "10696051277016237",
					"atList": null
				},
				"sort": [
					"--0RYXXxRkGEym8"
				]
			},
			{
				"_index": "chat_message_v01_bak",
				"_type": "colse",
				"_id": "--48zY4WTwa9n-O",
				"_score": null,
				"_source": {
					"contentType": "0x2",
					"corpId": "1970325139148973",
					"loginId": "1688852022700275",
					"chatType": 1,
					"deviceId": null,
					"serverId": "1445644",
					"sequence": "7823549",
					"isRecvMsg": 0,
					"recverId": "10696051277016234",
					"senderId": "1688852022700275",
					"serverWeChatId": "D00227",
					"conversationId": "R:10696051277016234",
					"content": "ğŸ“šä»Šå¤©é‘«é‘«è€å¸ˆç»™æ‚¨åˆ†äº«æ•°å­¦æ€ç»´å°ä¹ é¢˜æ¥å•¦[æ„‰å¿«]\nğŸ”æ²¡æœ‰æ”¶åˆ°å°ä¹ é¢˜çš„å®¶é•¿ï¼Œå›å¤æˆ‘ä¸€ä¸‹å“¦~\nğŸ–‡åªè¯´2ä¸ªäº‹æƒ…ï¼š\nğŸ”¹ä»Šæ™š8ç‚¹è¿˜æœ‰ä¸€åœºç›´æ’­æ´»åŠ¨ï¼Œå¯ä»¥ç›´æ’­æŠ½å¥–çš„å“¦~\nğŸ”¹åå¤©å¼€å§‹ï¼Œä»‹ç»æœ‹å‹ä¹°è¯¾ï¼Œç”±â€œæ¯é—¨å¹´è¯¾è¿”50å…ƒâ€æ”¹ä¸ºâ€œåªæœ‰é¦–å•è¿”50â€å•¦~",
					"clientId": "--48zY4WTwa9n-O",
					"sendTime": 1609329229,
					"offset": 524,
					"url": null,
					"fileName": null,
					"atList": null,
					"corporationId": 1
				},
				"sort": [
					"--48zY4WTwa9n-O"
				]
			},
			{
				"_index": "chat_message_v01_bak",
				"_type": "colse",
				"_id": "--6-crbSRnGSLfu",
				"_score": null,
				"_source": {
					"fileName": null,
					"loginId": "1688852022706519",
					"corporationId": 1,
					"serverWeChatId": "tian",
					"isRecvMsg": 0,
					"deviceId": null,
					"serverId": "1291030",
					"content": "6666",
					"senderId": "1688852022706519",
					"contentType": "0x2",
					"chatType": 1,
					"clientId": "--6-crbSRnGSLfu",
					"corpId": "1970325139148973",
					"offset": 33369,
					"conversationId": "R:10696051277016237",
					"url": null,
					"sendTime": 1607462328,
					"sequence": "12530627",
					"@timestamp": "2020-12-11T09:49:22.802397Z",
					"recverId": "10696051277016237",
					"atList": null
				},
				"sort": [
					"--6-crbSRnGSLfu"
				]
			}
		]
	}
}
~~~

ä½¿ç”¨sortè¿”å›çš„å€¼æœç´¢ä¸‹ä¸€é¡µï¼š

~~~json
curl -H 'Content-type: application/json' -XGET 'http://vpc-fat-133.zmaxis.com:9200/chat_message_v01_bak/_search?pretty' -d '
{
  "query": {
    "match_all": {}
  },
  "size": 3,
  "from": 0,
  "search_after": [
    "--6-crbSRnGSLfu"
  ],
  "sort": [
    {
      "_id": {
        "unmapped_type": "keyword",
        "order": "asc"
      }
    }
  ]
}
'
~~~

~~~json
{
	"took": 141,
	"timed_out": false,
	"_shards": {
		"total": 1,
		"successful": 1,
		"skipped": 0,
		"failed": 0
	},
	"hits": {
		"total": {
			"value": 10000,
			"relation": "gte"
		},
		"max_score": null,
		"hits": [
			{
				"_index": "chat_message_v01_bak",
				"_type": "colse",
				"_id": "--7Iz7fvT0SxNed",
				"_score": null,
				"_source": {
					"fileName": null,
					"loginId": "1688852022706519",
					"corporationId": 1,
					"serverWeChatId": "tian",
					"isRecvMsg": 0,
					"deviceId": null,
					"serverId": "1198832",
					"content": "6666",
					"senderId": "1688852022706519",
					"contentType": "0x2",
					"chatType": 1,
					"clientId": "--7Iz7fvT0SxNed",
					"corpId": "1970325139148973",
					"offset": 18018,
					"conversationId": "R:10696051277016238",
					"url": null,
					"sendTime": 1607413894,
					"sequence": "12484539",
					"@timestamp": "2020-12-11T09:47:47.054480Z",
					"recverId": "10696051277016238",
					"atList": null
				},
				"sort": [
					"--7Iz7fvT0SxNed"
				]
			},
			{
				"_index": "chat_message_v01_bak",
				"_type": "colse",
				"_id": "--B7ryEhTGCVS27",
				"_score": null,
				"_source": {
					"contentType": "0x2",
					"corpId": "1970325139148973",
					"loginId": "1688852951816966",
					"chatType": 1,
					"deviceId": null,
					"serverId": "1233554",
					"sequence": "3438223",
					"isRecvMsg": 1,
					"recverId": "1970324961140744",
					"senderId": "1688853104638131",
					"serverWeChatId": "wordACEgAAX5JWZ5hm42AteF9c8eT9tg",
					"conversationId": "R:1970324961140744",
					"content": "98889",
					"clientId": "--B7ryEhTGCVS27",
					"sendTime": 1607393729,
					"offset": 605,
					"url": null,
					"fileName": null,
					"atList": null,
					"corporationId": 1
				},
				"sort": [
					"--B7ryEhTGCVS27"
				]
			},
			{
				"_index": "chat_message_v01_bak",
				"_type": "colse",
				"_id": "--BN8dIaR_ah51_",
				"_score": null,
				"_source": {
					"fileName": null,
					"loginId": "1688852022706519",
					"corporationId": 1,
					"serverWeChatId": "tian",
					"isRecvMsg": 0,
					"deviceId": null,
					"serverId": "1277804",
					"content": "6666",
					"senderId": "1688852022706519",
					"contentType": "0x2",
					"chatType": 1,
					"clientId": "--BN8dIaR_ah51_",
					"corpId": "1970325139148973",
					"offset": 30925,
					"conversationId": "R:10696051277016232",
					"url": null,
					"sendTime": 1607455584,
					"sequence": "12524014",
					"@timestamp": "2020-12-11T09:49:11.966881Z",
					"recverId": "10696051277016232",
					"atList": null
				},
				"sort": [
					"--BN8dIaR_ah51_"
				]
			}
		]
	}
}
~~~

# ä»£ç ç¤ºä¾‹

https://blog.csdn.net/lsqingfeng/article/details/108572402?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_baidulandingword-0&spm=1001.2101.3001.4242

## æµ…åˆ†é¡µ

## scrollåˆ†é¡µ

## search_afteråˆ†é¡µ

# å‚è€ƒæ–‡æ¡£

https://juejin.cn/post/6890891504630366215
