# 全量复制

1. slave第一次启动时，连接Master，发送PSYNC命令，格式为`psync {runId} {offset}`

   > - `{runId}` 为master的运行id；`{offset}`为slave自己的复制偏移量
   > - 由于此时是slave第一次连接master，slave不知道master的runId，也不知道自己偏移量，这时候会传一个问号和-1，告诉master节点是第一次同步。格式为psync ? -1

2. 当master接收到`psync ? -1`时，就知道slave是要全量复制，就会将自己的`runId`和`offset`告知slave，回复命令`+fullresync {runId} {offset}`。同时，master会执行`bgsave`命令来生成RDB文件，并使用缓冲区记录此后的所有写命令

   > - slave接受到master的回复命令后，会保存master的runId和offset
   > - slave此时处于同步状态，如果此时收到请求，当配置参数slave-server-stale-data yes时，会响应当前请求，no则返回错误

3. master `bgsave`执行完毕，向Slave发送RDB文件，同时继续缓冲此期间的写命令。RDB文件发送完毕后，开始向Slave发送存储在缓冲区的写命令

4. slave收到RDB文件，丢弃所有旧数据，开始载入RDB文件；并执行Master发来的所有的存储在缓冲区里的写命令

5. 此后 master 每执行一个写命令，就向Slave发送相同的写命令

# 增量复制

1. 如果出现网络闪断或者命令丢失等异常情况时，当主从连接恢复后，由于从节点之前保存了自身已复制的偏移量和主节点的运行ID。因此会把它们当作psync参数发送给主节点，要求进行部分复制操作，格式为`psync {runId} {offset}`

2. 主节点接到psync命令后首先核对参数runId是否与自身一致，如果一致，说明之前复制的是当前主节点；之后根据参数offset在自身复制积压缓冲区查找，如果偏移量之后的数据存在缓冲区中，则对从节点发送+CONTINUE响应，表示可以进行部分复制；否则进行全量复制

3. 主节点根据偏移量把复制积压缓冲区里的数据发送给从节点，保证主从复制进入正常状态

   

